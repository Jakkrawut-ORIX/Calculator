<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>โปรแกรมคำนวนลีสซิ่งเบื้องต้น - ORIX Style (Final Result Adjustments)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ORIX Original Colors (STANDARD LIGHT MODE) */
:root {
    --orix-logo-blue: #003366; /* Deep Blue - Primary Color */
    --orix-logo-red: #E30613; /* ORIX Red - Highlight Color */
    
    --color-primary: #003366;
    --color-secondary: #E30613;
    --color-background: #F0F4F8; 
    --color-surface: #FFFFFF; 
    --color-text-primary: #2C3E50; 
    --color-text-secondary: #7F8C8D; 
    --color-text-highlight: #E30613; 
    --color-border: #E0E7EE; 
    --color-input-bg: #FFFFFF;
    --color-button-primary: #003366;
    --color-button-secondary: #E30613;

    --shadow-elevation: 0 4px 12px rgba(0, 0, 0, 0.08);
}

* {
    font-family: 'Kanit', sans-serif;
    box-sizing: border-box;
}

body {
    margin: 0;
    padding: 20px 10px;
    background: var(--color-background);
    color: var(--color-text-primary);
    line-height: 1.6;
    font-size: 0.95em;
    display: flex;
    justify-content: center;
}

.container {
    max-width: 900px;
    width: 100%;
    background: var(--color-surface);
    padding: 30px;
    border-radius: 8px;
    box-shadow: var(--shadow-elevation);
    border-top: 5px solid var(--color-primary); 
}

/* Header and Company Info (Unchanged) */
.header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--color-border);
}

.logo-container img {
    max-width: 60px;
    height: auto;
}

.company-info {
    text-align: right;
    line-height: 1.3;
}
.company-name {
    font-size: 0.9em;
    font-weight: 600;
}
.company-address {
    font-size: 0.7em;
    color: var(--color-text-secondary);
}

.header-title {
    font-size: 1.5em;
    font-weight: 700;
    color: var(--color-primary);
    text-align: left;
    margin: 0 0 25px 0;
    padding-bottom: 5px;
    border-bottom: 2px solid var(--color-secondary);
}

/* Main Layout (Unchanged) */
.calculation-layout {
    display: flex;
    gap: 30px;
}
.input-column {
    flex: 2;
}
.result-column {
    flex: 1.5;
    min-width: 250px;
}

/* Input Sections (Unchanged) */
.input-section {
    margin-bottom: 20px;
    padding: 10px;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    background-color: var(--color-surface);
}

.section-title {
    font-size: 1.1em;
    font-weight: 600;
    color: var(--color-primary);
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 1px dashed var(--color-border);
}

.form-row-compact {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    gap: 10px;
}
.form-row-compact label {
    flex: 1;
    font-weight: 500;
    color: var(--color-text-primary);
    font-size: 0.95em;
    white-space: nowrap;
}
.input-col {
    flex: 2;
}

.input-unit-group {
    display: flex;
    align-items: center;
}

.input-unit-group input, .input-unit-group select {
    flex-grow: 1;
    border: 1px solid var(--color-border);
    background-color: var(--color-input-bg);
    color: var(--color-text-primary);
    padding: 8px 10px;
    font-size: 0.9em;
    border-radius: 4px;
    text-align: right;
    transition: all 0.2s;
}

.input-unit-group .unit-text {
    padding: 0 8px;
    color: var(--color-text-secondary);
    font-size: 0.9em;
    white-space: nowrap;
}

/* Button Styling (Unchanged) */
.button-group-orix {
    margin: 20px 0;
    text-align: center;
}
.button-group-orix button {
    padding: 12px 30px;
    font-size: 1em;
    font-weight: 600;
    background-color: var(--color-button-primary);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
}
.button-group-orix button:hover {
    background-color: #004488;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}
.button-group-orix button#targetLeaseBtn {
    background-color: var(--color-button-secondary);
    margin-top: 10px;
}
.button-group-orix button#targetLeaseBtn:hover {
    background-color: #A0000A;
}


/* --- Result Column Styling (Right Side) --- */
.result-box {
    background-color: var(--color-surface); 
    border: 2px solid var(--color-primary); /* Blue border */
    border-radius: 6px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); 
}

.result-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0; 
    border-bottom: 1px dashed var(--color-border);
}
.result-row:last-of-type {
    border-bottom: none;
}

/* Style for Net Total Row (Top Row) */
.net-total-row {
    background-color: var(--color-surface); 
    border-radius: 4px;
    padding: 12px 0; 
    margin: -5px 0 5px 0; 
    border-bottom: 2px solid var(--color-border);
}

.net-total-row .result-label {
    font-weight: 700;
    font-size: 0.95em; 
    color: var(--color-text-primary);
}
.net-total-row .result-input {
    color: var(--color-primary); 
    font-weight: 800;
    font-size: 0.9em; 
}

.result-label {
    font-size: 0.9em; 
    color: var(--color-text-primary);
}

.down-payment-label {
    font-size: 0.9em; 
    color: var(--color-text-primary);
    display: flex;
    align-items: baseline;
    gap: 5px;
}
.down-payment-label .percent-display {
    font-weight: 500;
    color: var(--color-text-secondary);
    font-size: 0.8em; 
}


.result-value {
    display: flex;
    align-items: center;
}

.result-input {
    border: none;
    background: transparent;
    font-size: 0.9em; /* MATCHED TO INPUT FONT SIZE */
    font-weight: 700;
    color: var(--color-primary); 
    text-align: right;
    padding: 0;
    width: 120px; 
}
.result-input[readonly] {
    background-color: transparent;
}
.result-input[readonly]:focus {
    outline: none;
    box-shadow: none;
}

/* Highlight Lease Row (Most Prominent) */
.total-lease-row {
    margin-top: 15px;
    border-bottom: none;
    background-color: var(--color-surface); 
    /* ADJUSTED: Set padding-left/right to 0 and adjusted margins to fill parent padding */
    padding: 15px 0; 
    margin-left: -15px; /* Pull left edge out */
    margin-right: -15px; /* Pull right edge out */
    width: calc(100% + 30px); /* Fill the width of the parent box */
    
    border-radius: 0; /* Remove border radius here */
    border: 2px solid var(--color-secondary); /* Red border */
    border-left: none; /* Remove left border */
    border-right: none; /* Remove right border */
    
    /* Ensure internal content is aligned with original padding */
    display: flex; 
    padding-left: 15px; /* Re-add content padding */
    padding-right: 15px; /* Re-add content padding */
}

.total-lease-row .result-label {
    font-size: 1.0em; 
    font-weight: 700;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    line-height: 1.1;
}

/* Style for (In VAT) tag */
.lease-vat-tag {
    font-size: 0.7em; /* Reduced size for In VAT */
    font-weight: 400;
    color: var(--color-text-secondary);
}

.result-highlight {
    font-size: 1.15em; /* REDUCED SIZE FOR LEASE AMOUNT */
    color: var(--color-text-highlight);
    font-weight: 800;
}

.note-disclaimer {
    font-size: 0.8em;
    color: var(--color-text-secondary);
    line-height: 1.5;
    padding: 15px 0 0 0;
    border-top: 1px solid var(--color-border);
}

/* Responsive adjustments (Unchanged) */
@media (max-width: 768px) {
    .calculation-layout {
        flex-direction: column;
        gap: 20px;
    }
    .input-column {
        padding-bottom: 0;
        border-bottom: none;
    }
    .result-column {
        min-width: unset;
    }
    .container {
        padding: 20px;
    }
    .header-title {
        font-size: 1.4em;
    }
    .form-row-compact label {
        flex: 1.2;
    }
    .input-col {
        flex: 1.8;
    }
}
@media (max-width: 500px) {
    .header-content {
        flex-direction: column;
        align-items: flex-start;
    }
    .company-info {
        text-align: left;
        margin-top: 10px;
    }
}
</style>
</head>
<body>
<div class="container">
    <div class="header-content">
        <div class="logo-container">
            </div>
        <div class="company-info">
            <div class="company-name">บริษัท ไทยโอริกซ์ลีสซิ่ง จำกัด</div>
            <div class="company-address">555 รสา วัน (อาคาร บี) ยูนิต 1801 ชั้น 18 และ ชั้น 19<br>
            ถนนพหลโยธิน แขวงจตุจักร เขตจตุจักร กรุงเทพฯ 10900<br>
            โทรศัพท์: 66(0) 2792-4500</div>
        </div>
    </div>
    
    <div class="header-title">โปรแกรมคำนวนลีสซิ่งเบื้องต้น</div>
    
    <div class="calculation-layout">
        <div class="input-column">
            <div class="input-section">
                <h2 class="section-title">ข้อมูลเบื้องต้น</h2>
                <div class="input-section-content">
                    <div class="form-row-compact">
                        <label for="carPrice">ราคารถ</label>
                        <div class="input-col">
                            <div class="input-unit-group">
                                <input id="carPrice" type="text" value="0.00">
                                <span class="unit-text">บาท</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-row-compact">
                        <label for="discount">ส่วนลด</label>
                        <div class="input-col">
                            <div class="input-unit-group">
                                <input id="discount" type="text" value="0.00">
                                <span class="unit-text">บาท</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-row-compact">
                        <label for="option">Option</label>
                        <div class="input-col">
                            <div class="input-unit-group">
                                <input id="option" type="text" value="0.00">
                                <span class="unit-text">บาท</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-section">
                <h2 class="section-title">เงินดาวน์และระยะเวลา</h2>
                <div class="input-section-content">
                    <div class="form-row-compact">
                        <label for="downType">รูปแบบเงินดาวน์</label>
                        <div class="input-col">
                            <select id="downType" onchange="calculate()">
                                <option value="percent">เป็น %</option>
                                <option value="amount">เป็นจำนวนเงิน</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row-compact">
                        <label for="downInput">กรอก % / จำนวน</label>
                        <div class="input-col">
                            <div class="input-unit-group">
                                <input id="downInput" type="text" value="0.00">
                                <span class="unit-text percent-display" id="downInputUnit">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-row-compact">
                        <label for="interestRate">อัตราดอกเบี้ยต่อปี (%)</label>
                        <div class="input-col">
                            <div class="input-unit-group">
                                <input id="interestRate" type="text" value="0.00">
                                <span class="unit-text">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-row-compact">
                        <label for="termYears">จำนวนปี</label>
                        <div class="input-col">
                            <div class="input-unit-group">
                                <input id="termYears" type="number" step="1" value="0">
                                <span class="unit-text">ปี</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="button-group-orix">
                <button id="calculateBtn" onclick="calculate()">คำนวณ</button>
                <button id="targetLeaseBtn" onclick="calculateDownForTargetLease(36000)">คำนวณเงินดาวน์สำหรับค่างวด 36,000 บาท</button>
            </div>
        </div>

        <div class="result-column">
            <h2 class="section-title">ผลการคำนวณ</h2>
            <div class="result-box">
                <div class="result-row net-total-row">
                    <span class="result-label">ราคาสุทธิ</span>
                    <span class="result-value">
                        <input id="totalAmount" readonly class="result-input">
                        <span class="unit-text">บาท</span>
                    </span>
                </div>
                
                <div class="result-row">
                    <span class="down-payment-label">
                        เงินดาวน์
                        <span id="downPercentDisplay" class="percent-display"></span>
                    </span>
                    <span class="result-value">
                        <input id="downAmount" readonly class="result-input">
                        <span class="unit-text">บาท</span>
                    </span>
                </div>
                
                <div class="result-row">
                    <span class="result-label">ยอดจัด</span>
                    <span class="result-value">
                        <input id="financeAmt" readonly class="result-input">
                        <span class="unit-text">บาท</span>
                    </span>
                </div>
                
                <div class="result-row">
                    <span class="result-label">ดอกเบี้ยรวม</span>
                    <span class="result-value">
                        <input id="intTotal" readonly class="result-input">
                        <span class="unit-text">บาท</span>
                    </span>
                </div>
                
                <div class="result-row total-lease-row">
                    <span class="result-label">
                        ค่างวดต่อเดือน
                        <span class="lease-vat-tag">(In VAT)</span>
                    </span>
                    <span class="result-value">
                        <input id="leaseInVat" readonly class="result-input result-highlight">
                        <span class="unit-text">บาท</span>
                    </span>
                </div>
            </div>
            
            <div class="note-disclaimer">
                *ผลการคำนวณข้างต้นเป็นตัวเลขประมาณการเท่านั้น และอัตราดอกเบี้ยอาจมีการเปลี่ยนแปลง โปรดติดต่อเจ้าหน้าที่เพื่อรับอัตราที่แน่นอน
            </div>
        </div>
    </div>
    
</div>

<div style="display: none;">
    <input id="qsDownPercent" type="hidden">
    </div>

<script>
// Helper functions for number formatting (Unchanged)
function format(n, decimals = 2) {
    if (isNaN(n) || n === null) return "0.00";
    return new Intl.NumberFormat('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(parseFloat(n));
}

function formatNoDecimal(n) {
    return format(n, 0);
}

function format4(n) {
    if (isNaN(n) || n === null) return "0.0000";
    return new Intl.NumberFormat('en-US', { minimumFractionDigits: 4, maximumFractionDigits: 4 }).format(parseFloat(n));
}

function uncomma(s) {
    const cleaned = String(s).replace(/,/g, '');
    const num = parseFloat(cleaned);
    return isNaN(num) ? 0 : num;
}

// IRR Function (Unchanged)
function calculateIRR(nper, pmt, pv, fv = 0, type = 0) {
    if (pmt === 0 && pv === 0) return NaN;
    if (nper <= 0) return NaN;
    
    let guess = 0.05 / 12;
    let rate = guess;
    const maxIter = 500;
    const tol = 1e-7;
    
    for (let i = 0; i < maxIter; i++) {
        let f = pv;
        let df = 0;
        
        for (let t = 1; t <= nper; t++) {
            const discountFactor = Math.pow(1 + rate, t - (type === 1 ? 1 : 0));
            f += pmt / discountFactor;
            df += -(t - (type === 1 ? 1 : 0)) * pmt / Math.pow(1 + rate, t + 1 - (type === 1 ? 1 : 0));
        }
        
        f += fv / Math.pow(1 + rate, nper);
        df += -nper * fv / Math.pow(1 + rate, nper + 1);
        
        if (Math.abs(f) < tol) return rate;
        
        const newRate = rate - f / df;
        if (Math.abs(newRate - rate) < tol) return newRate;
        if (isNaN(newRate) || !isFinite(newRate)) return NaN;
        
        rate = newRate;
    }
    
    return NaN;
}

// Display Down Payment Percentage (Unchanged)
function showDownPercent() {
    const total = uncomma(document.getElementById("totalAmount").value);
    const down = uncomma(document.getElementById("downAmount").value);
    const result = total > 0 ? (down / total * 100) : 0;
    document.getElementById("downPercentDisplay").innerText = `(${format(result, 2)}%)`;
    
    const qsDownPercentElement = document.getElementById("qsDownPercent");
    if (qsDownPercentElement) {
        qsDownPercentElement.value = format4(result) + '%';
    }
}

// Main Calculation Logic (Unchanged)
function calculate() {
    const getVal = id => uncomma(document.getElementById(id).value);
    const getIntVal = id => parseInt(uncomma(document.getElementById(id).value)) || 0;
    
    const car = getVal('carPrice');
    const discount = getVal('discount');
    const option = getVal('option');
    const total = car - discount + option;
    
    document.getElementById('totalAmount').value = format(total); 
    
    const downType = document.getElementById('downType').value;
    const downInput = getVal('downInput');
    let down = 0;

    document.getElementById('downInputUnit').innerText = (downType === 'percent') ? '%' : 'บาท';
    
    if (downType === 'percent') {
        down = total * (downInput / 100);
    } else {
        down = downInput;
    }
    
    if (down > total && total > 0) {
        alert("เงินดาวน์ไม่สามารถเกินราคารถได้ กรุณาใส่ข้อมูลใหม่");
        document.getElementById('downInput').value = format(total * 0.2);
        down = total * 0.2;
    } else if (down > total) {
        down = total;
    }
    
    document.getElementById('downAmount').value = format(down);
    
    const finance = total - down;
    const rate = getVal('interestRate');
    const years = getIntVal('termYears');
    const months = years * 12;
    
    if (months === 0) {
        document.getElementById('financeAmt').value = format(finance);
        document.getElementById('intTotal').value = format(0);
        document.getElementById('leaseInVat').value = format(0);
        showDownPercent();
        return;
    }
    
    const intTotal = finance * (rate / 100) * years;
    const financeTotalWithInterest = finance + intTotal;
    
    const leaseInVat = Math.ceil(financeTotalWithInterest / months);
    
    document.getElementById('financeAmt').value = format(finance);
    document.getElementById('intTotal').value = format(intTotal);
    document.getElementById('leaseInVat').value = format(leaseInVat);
    
    showDownPercent();
}

// Calculate Down Payment for Target Lease (Unchanged)
function calculateDownForTargetLease(targetLease) {
    const getVal = id => uncomma(document.getElementById(id).value);
    const getIntVal = id => parseInt(uncomma(document.getElementById(id).value)) || 0;
    
    const car = getVal('carPrice');
    const discount = getVal('discount');
    const option = getVal('option');
    const total = car - discount + option;
    
    document.getElementById('totalAmount').value = format(total);
    
    const rate = getVal('interestRate');
    const years = getIntVal('termYears');
    const months = years * 12;
    
    if (months === 0 || rate === 0 || total <= 0) {
        alert("กรุณาระบุ ราคารถ, จำนวนปี, และอัตราดอกเบี้ยให้ถูกต้องก่อนคำนวณเงินดาวน์สำหรับค่างวดเป้าหมาย.");
        return;
    }
    
    let low = 0;
    let high = total;
    let bestDown = 0;
    let minDiff = Infinity;
    const maxIter = 500;
    
    for (let i = 0; i < maxIter; i++) {
        const currentDown = Math.floor((low + high) / 2);
        if (currentDown < 0) currentDown = 0;
        if (currentDown > total) currentDown = total;
        
        const finance = total - currentDown;
        const intTotal = finance * (rate / 100) * years;
        const currentLease = months > 0 ? Math.ceil((finance + intTotal) / months) : 0;
        
        const diff = Math.abs(currentLease - targetLease);
        
        if (diff < minDiff) {
            minDiff = diff;
            bestDown = currentDown;
        }
        
        if (high - low <= 1) break;
        
        if (currentLease > targetLease) {
            low = currentDown;
        } else {
            high = currentDown;
        }
    }
    
    const financeFinal = total - bestDown;
    const intTotalFinal = financeFinal * (rate / 100) * years;
    const finalLease = months > 0 ? Math.ceil((financeFinal + intTotalFinal) / months) : 0;

    if (finalLease > targetLease) {
        bestDown = 0; 
        alert(`คำเตือน: ค่างวดที่คำนวณได้ (${format(finalLease)} บาท) มากกว่าค่างวดเป้าหมาย ${format(targetLease)} บาท แม้จะวางเงินดาวน์ 0 บาทก็ตาม.`);
    } else if (finalLease < targetLease) {
        const financeCheck = total - (bestDown + 1);
        const intTotalCheck = financeCheck * (rate / 100) * years;
        const leaseCheck = months > 0 ? Math.ceil((financeCheck + intTotalCheck) / months) : 0;

        if (leaseCheck > targetLease) {
             // bestDown is correct
        } else {
            bestDown = 0; 
        }
    }
    
    document.getElementById('downType').value = 'amount';
    document.getElementById('downInput').value = formatNoDecimal(bestDown);
    calculate();
}

// Event Listeners for input fields (Unchanged)
function addInputListeners(id) {
    const el = document.getElementById(id);
    if (!el) return;
    
    el.addEventListener('focus', () => {
        let currentVal = uncomma(el.value);
        if (Math.abs(currentVal) < 0.001) {
            el.value = '';
        } else {
            el.value = String(currentVal);
        }
    });
    
    el.addEventListener('blur', () => {
        let val = uncomma(el.value);
        if (id === 'termYears') {
            el.value = formatNoDecimal(val);
        } else if (id === 'interestRate') {
            el.value = format(val, 2);
        } else {
            el.value = format(val);
        }
        calculate();
    });
    
    el.addEventListener('input', () => {
        let sanitizedValue = el.value.replace(/[^0-9.]/g, '');
        const parts = sanitizedValue.split('.');
        if (parts.length > 2) {
            sanitizedValue = parts[0] + '.' + parts.slice(1).join('');
        }
        el.value = sanitizedValue;
    });
}

window.onload = () => {
    ['carPrice', 'discount', 'option', 'downInput', 'interestRate', 'termYears'].forEach(addInputListeners); 
    
    const downTypeElement = document.getElementById('downType');
    if (downTypeElement) downTypeElement.addEventListener('change', calculate);
    
    calculate();
};
</script>
</body>
</html>
